<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Document</title>
    <link rel="stylesheet" href="./public/styles/index.css" />
    <link rel="stylesheet" href="./public/styles/interactive.css" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Oxygen:wght@400;700&display=swap"
      rel="stylesheet"
    />
  </head>
  <body>
    <script></script>
    <script type="text/javascript" src="./public/js/lib.js" defer></script>
    <script type="module" src="./public/js/pages/aerial.js" defer></script>
    <script type="module" src="./public/js/pages/floors.js" defer></script>
    <script type="module" src="./public/js/pages/apartment.js" defer></script>
    <script src="./public/js/helpers/handleBackButton.js" defer></script>
    <script src="./public/js/helpers/onResize.js" defer></script>
    <script>
      function fetchData() {
        fetch(`https://www.residenceuskolky.cz/graphql`, {
          method: `POST`,
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            query: `
                query Nodes {
                  posts {
                    nodes {
                      slug
                      tags {
                        nodes {
                          name
                          slug
                        }
                      }
                      title
                      uri
                    }
                  }
                }`,
          }),
        })
          .then((res) => res.json())
          .then((data) => {
            const formattedData = data.data.posts.nodes.reduce(
              (acc, curr, i) => {
                const [buildingName, appartmentId] = curr.title.split(`.`);
                const buildingKey = buildingName.toLowerCase();
                const buildingType = buildingKey[0];
                const floorKey = appartmentId[0];
                return {
                  ...acc,
                  [buildingKey]: {
                    displayName: buildingName,
                    floors: {
                      ...acc[buildingKey]?.floors,
                      [floorKey]: {
                        displayName:
                          Number(floorKey) === 0 ? `1PP` : `${floorKey}NP`,
                        avaible: acc[buildingKey]?.floors[floorKey]
                          ? acc[buildingKey]?.floors[floorKey].avaible + 1
                          : 1,
                        apartments: {
                          ...acc[buildingKey]?.floors[floorKey]?.apartments,
                          [appartmentId]: {
                            area:
                              curr.tags.nodes.find((tag) =>
                                tag.name.match(/\d+(.\d)?mÂ²/g)
                              )?.name || ``,
                            dispositions:
                              curr.tags.nodes.find((tag) =>
                                tag.name.match(/\d\+(kk|\d)/gi)
                              )?.name || ``,
                            displayName: curr.title,
                            avaible: curr.tags.nodes
                              .map((tag) => tag.slug)
                              .some((tag) => tag === "volny"),
                          },
                        },
                      },
                    },
                    avaible: i + 1,
                  },
                };
              },
              {}
            );
            window.data = formattedData;
            window.dispatchEvent(new Event("dataloaded"));
          });
      }

      function parseQuery() {
        const search = window.location.search;
        if (search.length === 0) return {};
        return search
          .slice(1)
          .split("&")
          .reduce((acc, curr) => {
            const currQuery = curr.split("=");
            return { ...acc, [currQuery[0]]: currQuery[1] };
          }, {});
      }

      function router() {
        function parseMarkup(markup) {
          const body = document.querySelector("body");
          const parsedDocument = parser.parseFromString(markup, "text/html");
          body.prepend(parsedDocument.body.firstChild);
        }

        const query = parseQuery();
        const page = Object.keys(query).join("/");
        const parser = new DOMParser();
        if (page === "") {
          parseMarkup(aerialMarkup);
          const getAerialData = aerialData();
          getAerialData.forEach(window.initInteractive);
        }
        if (page === "building") {
          parseMarkup(floorsMarkup);
          handleBackButton();
          const data = floorsData();
          data.forEach(window.initInteractive);
        }
        if (page === "building/floor") {
          parseMarkup(apartmentMarkup);
          handleBackButton();
          const data = apartmentData();
          data.forEach(window.initInteractive);
        }
      }

      addEventListener("locationchange", () => {
        document.querySelector("body").innerHTML = "";
        router();
      });
      addEventListener("dataloaded", router);
      addEventListener("resize", () => window.handleResize());
      fetchData();
    </script>
  </body>
</html>
